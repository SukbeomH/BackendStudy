# BE Day24 결제 & 아임포트

**목차**

  

---

# 결제의 종류

우리의 서비스에 결제 기능이 필요해서 만들어야 된다고 할 때, 

`결제 기능 하나 만드는거? 얼마 안걸리겠네` 라고 쉽게 생각할 수 있습니다. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled.png)

하지만, 위의 그림을 보시면 클라이언트가 결제를 한다고 했을 때, 고려해야하는 경우의 수가 생각보다 많습니다. 

한번 결제하고 끝나는 일반 결제인지, 정기적으로 결제되어야하는 것인지에 따라 다른 API, 다른 로직이 필요합니다. 무통장 입금의 경우 환불해줄 계좌번호를 또 알아야하기 때문에 카드 결제를 취소하는 것과는 또 달라지게 됩니다. 이렇게 각각의 분기, 상황마다 그에 맞는 기능을 따로 따로 구현해줘야합니다. 

하나 만든다고 자동으로 되는게 아니라, 다 만들어야한다는 뜻입니다. 😧

---

# 결제 프로세스

우리가 인터넷을 통해 옷을 구매하는 과정은 아래와 같습니다.

1.  구매자가 구입할 옷에 대한 정보와 금액을 판매자에게 전달
2.  판매자는 전달받은 금액을 PG사에게 결제해줄 것을 요청
3.  PG사는 요청받은 정보를 은행사에게 다시 결제 요청
4.  은행사는 요청받은 금액을 구매자의 계좌에서 출금 후 PG사로 전달 
5.  PG사는 판매자에게 금액을 전달 (일정량의 수수료를 제외)
6.  판매자는 금액 확인 후, 구매자에게 옷을 배송

PG는 **P**ayment **G**ateway 의 줄임말로

구매자와 판매자 사이에서의 이뤄지는 결제를 안전하게 할 수 있도록

대행해주는 역할을 담당합니다.

대표적인 PG사로는

**KG 이니시스, NHN, KCP, LGU+** 등이 있으며

모바일 환경으로는

**KG 모빌리언스, 다날, 카카오Pay** 등이 있습니다.

개발자가 직접 결제 프로세스를 프로젝트에 적용하는 방법은

꽤나 잔인한 과정이 될 수가 있습니다.

![BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/____.png](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/____.png)

결제 연동 시스템을 직접 구현한다면 위와 같은 과정을 거쳐야 하는데

최소 2주 이상은 온전하게 결제 연동에 매달려야 구현이 가능한 수준입니다.

이 복잡하고 까다로운 과정을 대신 해결해주는 결제 외부 API를 사용하면

정말 간단하게 결제 시스템을 구현할 수 있습니다.

아임포트 (I'mport) 는 개발환경과 상관없이

원하는 PG사와의 결제시스템을 연결시켜주는 결제 API 서비스입니다. (결제 솔루션)

![BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/__.png](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/__.png)

실제로 아임포트가 제공하는 API 를 사용하면

PG사와의 연결 과정은 모두 아임포트가 대신 처리해주기 때문에

복잡한 결제환경을 직접적으로 구현할 필요가 없어집니다.

---

# imp_uid의 이동 흐름

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%201.png)

1. 브라우저에서 결제하기 버튼을 클릭하면 프론트엔드에서 `아임포트`에 **Rest API**로 결제를 요청합니다.
2. 아임포트는 PG사에 결제를 요청합니다.
3. PG사는 카드사에 결제를 요청합니다.
4. 결제가 다 되면, 아임포트가 결제건에 대한 ID값을 보내줍니다. 이를 `imp_uid`라고 합니다. 
5. 프론트 엔드는 받은 imp_uid를 백엔드에 건내줍니다.
6. 백엔드는 DB에 결제 정보와 함께 imp_uid를 저장합니다. 

---

# 아임포트 사용하기

## 아임포트 초기 설정

아임포트를 사용하기 위해서는

아임포트 아이디가 필요합니다.

아임포트 홈페이지로 접속해주세요.

[개발자를 위한 무료 결제연동 API, 아임포트](https://www.iamport.kr/)

페이지 접속 후,

상단 오른쪽에 있는 **대작하기** 를 클릭해 가입 화면으로 들어갑니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%202.png)

회원가입을 통해 아이디를 생성하고 로그인을 해주세요.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%203.png)

아임포트에 로그인을 하게 되면

관리자 페이지에 접속할 수 있게 됩니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%204.png)

관리자 페이지에서는

아임포트를 사용하기 위한 **기본적인 설정**부터

아임포트가 연결시켜준 **PG사의 정보**와 **실제 결제내역**까지 확인할 수 있습니다.

아임포트를 사용하기 위해서는

먼저 사용할 PG사를 선택해야 합니다.

관리자 페이지에서

**시스템 설정 - PG설정 (일반결제 및 정기결제)** 페이지로 이동합니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%205.png)

PG 설정 페이지에서는

결제에 필요한 PG사를 설정할 수 있습니다.

PG사 선택창을 클릭하면 여러종류의 PG사들이 나타나는데

**KG이니시스(웹표준결제창)** 을 선택합니다. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%206.png)

<aside>
❗ 위의 화면과 달리 기본 PG사가 없으시다면
왼쪽 목록에 있는 **PG사 추가** 버튼으로 추가하셔야 합니다.

</aside>

PG설정으로 PG사를 설정할 경우

앞으로 이뤄지는 모든 결제과정에서는

해당 PG사로 연결되어 결제가 이루어지게 됩니다.

테스트 모드에 체크가 되어있는지 확인 후, 전체 저장을 누릅니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%207.png)

<aside>
❗ 반드시, **테스트모드**에 **체크가 되어 있는지 확인**해주세요.
테스트모드가 아닌 경우에는 실제로 결제가 이루어집니다.

(KG이니시스 PG사 테스트의 경우 결제를 하면 계좌에서 금액이 출금되지만
**당일 자정 이전에 모두 결제가 취소되어 환급**됩니다.)

</aside>

---

# 실습

# 포인트 충전 : 프론트엔드

포인트를 충전하는 기능을 만들기 위해, 먼저 프론트엔드 부분을 구현해보겠습니다. 

**class** 폴더 밑에 `23-01-point-transaction-frontend` 라는 이름의 새 폴더를 생성합니다. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%208.png)

그리고 안에 `21-03-login-oauth-google` 폴더의 **backend** 폴더를 복사 붙여넣기합니다. 

`frontend` 폴더를 만들어 `payment.html` 파일을 만들어줍니다. 

<aside>
📖 이 내용은 아임포트 DOCS 페이지에도 잘 설명되어 있습니다.
해당 페이지를 참고해보세요!

[https://docs.iamport.kr/implementation/payment](https://docs.iamport.kr/implementation/payment)

</aside>

`payment.html` 파일에 코드를 작성해보겠습니다. 

HTML 기본 틀을 잡아주고, 아임포트 라이브러리와 아임포트를 쓰기 위해 jquery 라이브러리를 추가합니다. 

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>결제하기</title>
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.12.4.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"
    ></script>
  </head>
  <body>
    결제할 금액: <input type="text" id="amount" />
    <button onclick="mypayment()">결제하기</button>
  </body>
</html>
```

작성한 html 파일을 **라이브 서버**로 띄워주세요. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%209.png)

`결제하기 버튼`을 눌렀을 때 실행될 함수 `mypayment`를 만들어보겠습니다. 

**script** 태그를 만들어 **mypayment** 함수를 작성해주세요.

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>결제하기</title>
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.12.4.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/axios/dist/axios.min.js"
    ></script>
    <script>
      function mypayment() {

      }
    </script>
  </head>
  <body>
    결제할 금액: <input type="text" id="amount" />
    <button onclick="mypayment()">결제하기</button>
  </body>
</html>
```

먼저 결제할 금액을 input 태그에서 가져옵니다. 

```jsx
function mypayment() {
	const myAmount = Number(document.getElementById('amount').value)
}
```

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2010.png)

공식 문서에 나온 것처럼, 

아임포트를 프로젝트에서 사용하기 위해서는

사용하려는 아임포트의 **식별코드를 설정**해줘야 합니다.

가맹점 식별코드는

아임포트 관리자 페이지의 **시스템 설정 - 내 정보 - 가맹점 식별코드**에서 확인할 수 있습니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2011.png)

아래와 같이 `mypayment` 함수를 작성합니다. 

```jsx
function mypayment() {
	const myAmount = Number(document.getElementById('amount').value)

	const IMP = window.IMP // 생략 가능
  IMP.init('imp26888962') // Example: imp00000000
}
```

식별코드까지 설정이 완료됐다면

이제 아임포트의 결제창을 불러올 수 있습니다.

```jsx

  IMP.request_pay({
			pg: "html5_inicis",
      pay_method: "card",
      name: "마우스",
      amount: myAmount,
      buyer_email: "gildong@gmail.com",
      buyer_name: "홍길동",
      buyer_tel: "010-4242-4242",
      buyer_addr: "서울특별시 강남구 신사동",
      buyer_postcode: "01181",
			m_redirect_url: "", // 모바일 결제후 리다이렉트될 주소!!		
  }, function (rsp) { // callback
				if (rsp.success) {
           alert('결제가 성공했습니다.');

            // 결제 성공 로직
						console.log(rsp)

        } else {
            alert('결제에 실패했습니다.');

            // 결제 실패 로직
        }
   });
```

이 코드를 추가하면, 아임포트가 연결해주는 **PG사의**

**결제페이지**를 프로젝트에서 사용할 수 있게됩니다.

결제가 성공하거나 실패하냐에 따라서

실행되는 로직을 만들어줄 수도 있습니다.

결제 파라미터에서 pg 나 pay_method 부분에서는

어떤 PG사를 이용할 건지, 어떤 결제 방식을 사용할 건지 선택이 가능하고

name 또는 amount 에는 **주문 이름과 결제 금액**,

buyer 에는 **구매자에 대한 정보**를 추가로 넣어줄 수 있습니다.

<aside>
📖 결제 파라미터의 정보는 아래의 DOCS 페이지를 참고해주세요.
[https://docs.iamport.kr/tech/imp](https://docs.iamport.kr/tech/imp)

</aside>

위의 코드를 `mypayment` 함수에 넣어줍니다. 

`payment.html`

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>결제하기</title>
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.12.4.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"
    ></script>
    <script>
      function mypayment() {
        const myAmount = Number(document.getElementById('amount').value)

        const IMP = window.IMP // 생략 가능
        IMP.init('imp49910675') // Example: imp00000000
        IMP.request_pay(
          {
            pg: 'html5_inicis',
            pay_method: 'card',
            name: '마우스',
            amount: myAmount,
            buyer_email: 'gildong@gmail.com',
            buyer_name: '홍길동',
            buyer_tel: '010-4242-4242',
            buyer_addr: '서울특별시 강남구 신사동',
            buyer_postcode: '01181',
            m_redirect_url: '' // 모바일 결제후 리다이렉트될 주소!!
          },
          async (rsp) => {
            // callback
            if (rsp.success) {
              // 결제 성공시
              console.log(rsp)

            } else {
              // 결제 실패시
            }
          }
        )
      }
    </script>
  </head>
  <body>
    결제할 금액: <input type="text" id="amount" />
    <button onclick="mypayment()">결제하기</button>
  </body>
</html>
```

`payment.html` 파일을 위와 같이 완성했다면, 직접 결제를 해보겠습니다.

라이브서버로 켜두었던 브라우저에서 원하는 금액(최소 100원)을 입력한 후 `결제하기` 버튼을 누릅니다. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2012.png)

모두 적용이 됐다면 프로젝트에서는 위와 같이

프로젝트에 설정된 PG사의 결제 페이지가 오픈됩니다.

원하는 결제 수단을 선택해 실제로 결제를 해봅니다.

결제페이지에서는 실제로 결제가 가능하며

테스트 버전이라면 PG사마다 상이하지만

당일 자정 전에는 모두 취소되어 환불됩니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2013.png)

위의 그림과 같이, 결제 과정까지 성공했다면

결제에 성공했을 때 설정했던 로직이 실행이 되고 (`console.log(rsp)`)

반대로 실패했을 때에는

결제 실패에 설정했던 로직을 실행시킬 수 있습니다.

<aside>
❗ 결제에 실패하셨다면, 결제 금액을 한번 확인해보세요!
**100원 미만**으로는 결제를 할 수 없습니다!

</aside>

## 결제 내역

아임포트의 관리자 페이지의 **결제승인내역** 페이지에서

현재까지의 결제내역 (실패 및 성공) 들을 확인(검색)할 수 있습니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2014.png)

결제내역 페이지에서는 결제된 내역들에 대한 정보를 볼 수 있고

**'imp_'** 로 시작되는 고유한 결제 ID 값도 확인할 수 있습니다.

![BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/K-066.png](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/K-066.png)

결제가 성공한 내역을 한해서, 취소가 가능하므로

테스트로 잘못된 금액이 지불되었다면

꼭 취소하기 버튼으로 환불을 진행해주세요.

---

# 포인트 충전 : entity

결제가 완료된 다음, 아임포트에서 보내준 imp_uid를 비롯한 결제 정보를 백엔드에 보내줘야합니다.

먼저 포인트 충전에 대한 DB를 만들겠습니다.

`23-01-point-transaction-frontend` 폴더를 복사 붙여넣기 해 사본을 만들고, 

폴더 이름을 `23-02-point-transaction-backend-entity`로 변경해주세요. 

`backend/src/pointTransaction/entities/pointTransaction.entity.ts`  파일을 만들어주세요.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2015.png)

**PointTransaction**의 `entity`를 작성해줍니다.

```tsx
import { ObjectType, Field, Int, registerEnumType } from '@nestjs/graphql';
import { User } from 'src/apis/user/entities/user.entity';
import {
  Column,
  CreateDateColumn,
  Entity,
  ManyToOne,
  PrimaryGeneratedColumn,
} from 'typeorm';

export enum POINT_TRANSACTION_STATUS_ENUM {
  PAYMENT = 'PAYMENT',
  CANCEL = 'CANCEL',
}
registerEnumType(POINT_TRANSACTION_STATUS_ENUM, {
  name: 'POINT_TRANSACTION_STATUS_ENUM',
});

@Entity()
@ObjectType()
export class PointTransaction {
  @PrimaryGeneratedColumn('uuid')
  @Field(() => String)
  id: string;

  @Column()
  @Field(() => String, { nullable: true })
  impUid: string;

  @Column()
  @Field(() => Int)
  amount: number;

  @Column({ type: 'enum', enum: POINT_TRANSACTION_STATUS_ENUM })
  @Field(() => POINT_TRANSACTION_STATUS_ENUM)
  status: POINT_TRANSACTION_STATUS_ENUM;

  @ManyToOne(() => User)
  @Field(() => User)
  user: User;

  @CreateDateColumn()
  @Field(() => Date)
  createdAt: Date;
}
```

## enum POINT_TRANSACTION_STATUS_ENUM

`PointTransaction` 테이블에는 **id, impUid, amount, status, user, createdAt** 이 들어갑니다. 

이 중에서 `status`에는 **enum**을 사용해서 정해진 문자열이 들어가도록 했습니다. 

타입스크립트의 enum을 사용해서 만들어서 타입을 정의해주고, 

```tsx
enum POINT_TRANSACTION_STATUS_ENUM {
  PAYMENT = 'PAYMENT',
  CANCEL = 'CANCEL',
}
```

이를 그래프큐엘에서 쓰기 위해 `registerEnumType` 함수 안에 넣어주었습니다. 

```tsx
registerEnumType(POINT_TRANSACTION_STATUS_ENUM, {
  name: 'POINT_TRANSACTION_STATUS_ENUM',
});
```

이렇게 만든 enum 타입을 **status** 에 적어줍니다. 

```tsx
@Column({ type: 'enum', enum: POINT_TRANSACTION_STATUS_ENUM })
@Field(() => POINT_TRANSACTION_STATUS_ENUM)
status: POINT_TRANSACTION_STATUS_ENUM;
```

<aside>
💡 **enum** type : 열거형
정해진 특정한 값만 가질 수 있습니다. 즉, 허용된 값들 중에 하나를 가지게됩니다.

[Handbook - Enums](https://www.typescriptlang.org/ko/docs/handbook/enums.html)

</aside>

---

# 포인트 충전 : API

이제 실제로 프론트엔드에서 결제 정보를 받아 DB에 저장하는 API를 만들겠습니다. 

`23-02-point-transaction-backend-entity` 폴더를 복사 붙여넣기해 사본을 만들고,

`23-03-point-transaction-backend-api` 로 이름을 변경해주세요.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2016.png)

`backend > src > apis > pointTransaction` 위치에

**module**, **resolver**, **service** 파일을 각각 만들어줍니다. 

먼저 **pointTransaction.resolver.ts** 파일에서 `resolver`를 작성합니다. 

```tsx
import { UseGuards } from '@nestjs/common';
import { Args, Mutation, Resolver } from '@nestjs/graphql';
import { GqlAuthAccessGuard } from 'src/common/auth/gql-auth.guard';
import { CurrentUser, ICurrentUser } from 'src/common/auth/gql-user.param';
import { PointTransaction } from './entities/pointTransaction.entity';
import { PointTransactionService } from './pointTransaction.service';

@Resolver()
export class PointTransactionResolver {
  constructor(
    private readonly pointTransactionService: PointTransactionService,
  ) {}

  @UseGuards(GqlAuthAccessGuard)
  @Mutation(() => PointTransaction)
  createPointTransaction(
    @Args('impUid') impUid: string,
    @Args('amount') amount: number,
    @CurrentUser() currentUser: ICurrentUser,
  ) {
    return this.pointTransactionService.create({ impUid, amount, currentUser });
  }
}
```

프론트엔드에서 impUid와 결제 금액 amount를 받습니다.

가드를 이용해서 어떤 유저인지 받아옵니다. 

이것들을 서비스의 `create` 함수로 넘겨줍니다. 

이어서 `pointTransaction.service.ts` 파일에서 서비스를 작성합니다. 

```tsx
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from '../user/entities/user.entity';
import {
  PointTransaction,
  POINT_TRANSACTION_STATUS_ENUM,
} from './entities/pointTransaction.entity';

@Injectable()
export class PointTransactionService {
  constructor(
    @InjectRepository(PointTransaction)
    private readonly pointTransactionRepository: Repository<PointTransaction>,

    @InjectRepository(User)
    private readonly userRepository: Repository<User>,
  ) {}

  async create({ impUid, amount, currentUser }) {
    const pointTransaction = await this.pointTransactionRepository.create({
      impUid,
      amount,
      user: currentUser,
      status: POINT_TRANSACTION_STATUS_ENUM.PAYMENT,
    });
    await this.pointTransactionRepository.save(pointTransaction);

    const user = await this.userRepository.findOne({ id: currentUser.id });
    await this.userRepository.update(
      { id: user.id },
      { point: user.point + amount },
    );
    return pointTransaction;
  }
}
```

pointTransaction 테이블에 받아온 데이터를 저장합니다. 

그리고 유저 테이블에 가서 유저의 포인트를 충전한 만큼 증가시킵니다. 

이제 모듈을 만들어 리졸버와 서비스를 합쳐줍니다.

`pointTransaction.module.ts`

```tsx
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from '../user/entities/user.entity';
import { PointTransaction } from './entities/pointTransaction.entity';
import { PointTransactionResolver } from './pointTransaction.resolver';
import { PointTransactionService } from './pointTransaction.service';

@Module({
  imports: [TypeOrmModule.forFeature([PointTransaction, User])],
  providers: [
    PointTransactionResolver, //
    PointTransactionService,
  ],
})
export class PointTransactionModule {}
```

마지막으로

`app.module.ts`에 **PointTransactionModule**을 추가해줍니다.

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2017.png)

이제 서버를 띄워, 플레이그라운드에 접속합니다. 

만들었던 유저로 로그인을 해 access token를 받아줍니다. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2018.png)

---

API를 요청하기 위해 프론트엔드에 추가해줘야할 부분이 있습니다. 

먼저, axios 라이브러리를 추가합니다. 

```html
<script
  type="text/javascript"
  src="https://unpkg.com/axios/dist/axios.min.js"
></script>
```

`payment.html`

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2019.png)

기존에 만들었던 `mypayment` 함수에서 결제가 성공했을 때, `aixos`를 이용해 백엔드로 API 요청을 보내는 코드를 추가합니다. 복사했던 access token도 헤더에 넣어줍니다. 

```jsx
async (rsp) => {
  // callback
  if (rsp.success) {
    // 결제 성공시
    console.log(rsp)

    const data = await axios.post(
      'http://localhost:3000/graphql',
      {
        query: `
                mutation {
                  createPointTransaction(
                      impUid: "${rsp.imp_uid}", 
                      amount: ${rsp.paid_amount}) {
                            id
                         }
                       }
                `
      },
      {
        headers: {
          authorization: 'Bearer 액세스 토큰' // 플레이그라운드에서 로그인 후 얻은 토큰
        }
      }
    )

    console.log(data)
  } else {
    // 결제 실패시
  }
}
```

위의 코드를 `payment.html` 파일에 추가합니다. 

![무제.png](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/%EB%AC%B4%EC%A0%9C.png)

이제 라이브서버로 html 파일을 열고 다시 충전을 해봅니다. 💳

잘 결제가 됐다면, dbeaver로 확인해봅니다. 

![Untitled](BE%20Day24%20%E1%84%80%E1%85%A7%E1%86%AF%E1%84%8C%E1%85%A6%20&%20%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B7%E1%84%91%E1%85%A9%E1%84%90%E1%85%B3%20672a6ca7afe944a5ad3e2603dc74cd79/Untitled%2020.png)