# BE Day33 GCP 인스턴스 배포

---

  **목차**

  

---

# 배포 환경(local, dev, stage, prod) 분리

프로젝트를 서버에 배포할 때, 배포 환경에는 `4단계`가 있습니다.

쉽게 말해 하나의 배포 환경이 하나의 컴퓨터에 구성된다고 생각하면 됩니다. 

우리가 여태 개발한 코드를 바로 프로덕션으로 배포하면 될 것 같은데, 왜 4단계나 필요할까요? 

먼저 **로컬 개발 환경**이 있습니다.

`local` : 우리가 각자의 컴퓨터로 계속 작업하고 있었던 환경을 말합니다.  즉, localhost를 사용하는 개발 환경입니다. 여기서 배포하면 내 컴퓨터에서만 접근할 수 있습니다.

두번째로 `dev` 단계가 있습니다. 

`dev` : 나 혼자만의 작업환경을 넘어서, 프론트엔드와 백엔드를 합쳐서 테스트 해 볼 환경이 필요합니다. 개발자들이 실제 서버 환경에서 테스트 하면서 개발할 수 있습니다.

세번째를 소개하기 전에 먼저, 네번째로 `prod` 단계가 있습니다. 

`prod` : 개발을 완성한 다음에 실제로 서비스를 배포하고 운영하는 환경을 말합니다. **prod**는 **production**의 약자입니다. 여기에 있는 DB는 실제 유저의 DB이기 때문에 매우 중요하고 함부로 삭제하면 안 됩니다.

세번째로 **stage** 단계가 있습니다. 

dev 환경에서 개발하고 prod로 서비스를 배포하면 될 것 같은데, 왜 stage 단계가 필요할까요?

`stage` : 예를 들어 버전 1을 **prod**에 배포하고 서비스를 운영합니다. 새로운 기능을 추가한 버전2를 **dev**에서 개발자들이 만들었습니다. 

실제 서비스에 배포해도 될 정도의 수준으로 완성을 했고, prod 환경이랑 동일하게 stage 환경을 만들고 여기에 배포를 합니다. 기획자, PM, 디자이너 등이 여기에 올라간걸로 테스트를 해봅니다. 

stage는 실서비스 수준으로 배포하기 때문에, 여기서 잘 되면 DB만 빼고 prod로 배포합니다. 

이외에도 필요에 따라 더 다양한 단계를 구성하기도 합니다.

---

## 실습

`26-05-file-upload-thumbnail` 폴더를 복사해 붙여넣기 하고, 폴더명을 `35-01-deploy-with-docker` 로 변경합니다. 

도커로 배포하기 위해 기본적으로

`.dockerignore`, `.env`, `Dockerfile`, `docker-compose.yaml` 파일이 필요합니다. 

이 파일들은 기존에 배웠던 내용과 동일합니다. 

`.env`에는 소셜 로그인, 결제, 구글 스토리지를 위한 정보들이 들어있습니다. 깃허브에 올라가면 안되기 때문에 `.gitignore`에 포함되어 있는지 꼭 확인해주세요.

`.dockerignore` 파일 예시

```docker
dist/
.env*
node_modules/
```

`Dockerfile` 파일 예시

```docker
FROM node:16

WORKDIR /my_backend/
COPY ./package.json /my_backend/
COPY ./yarn.lock /my_backend/
RUN yarn install

COPY . /my_backend/
CMD yarn start:dev
```

`docker-compose.yaml` 파일 예시

```yaml
version: '3.3'

services:
  my_backend:
    build:
      context: .
      dockerfile: Dockerfile
		# env_file:
    #   - ./.env
    volumes:
      - ./src:/my_backend/src
    ports:
      - 3000:3000

  my_database:
    platform: linux/x86_64
    image: mysql:latest
    environment:
      MYSQL_DATABASE: 'myproject'
      MYSQL_ROOT_PASSWORD: 'root'
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    cap_add:
      - SYS_NICE
    ports:
      - 3306:3306
```

기본 파일들이 준비됐다면, 앞서 배운 개발 환경 단계에 맞게 파일을 만들어주겠습니다. 

먼저, `.env` 파일을 복사해 단계별로 파일을 각각 만들어주세요.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled.png)

추후에 환경에 맞게 안의 내용도 바꿔주면 됩니다. 

만든 .env 파일들을 `.gitignore`에 넣어주세요.

다음으로 `docker-compose.yaml` 파일도 복사해 3개 더 만들어줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%201.png)

각 yaml 파일에 env_file 설정을 바꿔주세요.

예 ) `docker-compose.dev.yaml` 파일에서는 `./.env.dev` 로

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%202.png)

다 준비되었다면,git에 커밋 후 push 합니다. 

<aside>
⚠️ 커밋하기 전, `.gitignore` 파일에 **.env***이 포함되어있는지 확인해주세요! 
env 파일들은 깃허브에 올라가면 안 됩니다!

</aside>

---

# GCP 인스턴스 배포

GCP의 인스턴스는 우리가 구글에서 하나의 컴퓨터를 빌리는 것입니다. 그리고 빌린 컴퓨터에 서버를 배포합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%203.png)

우리는 GCP를 사용하지만 아마존의 AWS, 마이크로소프트의 Azure 모두 비슷합니다. 

전체적인 도식은 아래와 같습니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%204.png)

구글에서 컴퓨터 하나를 빌려 그 안에 도커 컨테이너로 백엔드 서버와 DB를 띄우겠습니다. Storage에는 이미지 파일이 저장됩니다.

# 인스턴스 만들기

GCP 콘솔에 들어가서 로그인을 합니다. 

[Google Cloud Platform](https://console.cloud.google.com/)

이미지 파일 업로드를 위해 클라우드 스토리지를 만들었던 프로젝트를 선택합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%205.png)

사이드 메뉴를 열고, `Compute Engine`에서 `VM 인스턴스`를 들어갑니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%206.png)

처음 사용한다면, `Compite Engine API`를 사용할 것인지 물어봅니다. 사용을 누릅니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%207.png)

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%208.png)

`인스턴스 만들기`를 클릭합니다.

인스턴스 만들기 화면이 나오면

이름을 정해주고, 리전은 서울로합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%209.png)

밑으로 내려와

부팅 디스크 변경을 누릅니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2010.png)

설정은 다음과 같습니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2011.png)

나머지 설정은 그대로 두고 `만들기`를 합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2012.png)

잠시 기다리면 첫 인스턴스가 만들어집니다! 👏

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2013.png)

---

# 인스턴스에 Docker 설치

만들어진 인스턴스 컴퓨터의 터미널로 들어가겠습니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2014.png)

`SSH`를 클릭해 우리가 빌린 컴퓨터의 터미널로 접속합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2015.png)

`연결`을 클릭합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2016.png)

위와 같이 터미널창이 뜹니다.

이 컴퓨터는 처음 설정할 때 우분투 운영체제로 만들었습니다. 

우툰투는 먼저 apt를 업데이트 해줘야합니다. apt는 우분투의 패키지 관리 툴입니다. 맥의 brew라고 생각하면됩니다. 

터미널에 `sudo apt update` , `sudo apt upgrade` 명령어를 차례로 입력해 업데이트해줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2017.png)

도커로 배포를 할 것인데, 새 컴퓨터이기 때문에 도커가 없습니다.

아래 명령어를 차례로 입력해 설치해줍니다. 

- `sudo apt install docker.io`
    
    **do you want to continue?** 라는 질문이 나오면 `y`를 적고 엔터를 누릅니다. 
    

apt를 이용해 docker-compose를 설치하면 예전 버전이 설치되어, 다른 방법으로 2.2.3 버전을 설치하겠습니다. 아래 내용을 공식문서에 나오는 방법입니다.

[Compose V2](https://docs.docker.com/compose/cli-command/#install-on-linux)

아래 명령어를 한 줄씩 입력합니다.

- 폴더를 새로 생성합니다.
    
    `mkdir -p ~/.docker/cli-plugins/`
    

- 도커를 다운로드합니다.
    
    `curl -SL https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose`
    

- 도커가 있는 폴더에 권한을 줍니다.
`chmod +x ~/.docker/cli-plugins/docker-compose`

마지막으로 잘 설치되었는지 버전을 확인합니다.
`docker compose version`
 결과 )  Docker Compose version v2.2.3

이제 도커는 다 설치가 되었습니다.

---

# root 권한 해제

리눅스에서 특정 명령을 실행하거나 파일에 접근하기 위해서는 루트(root) 권한이 필요합니다. 

사용자가 root 권한을 사용하기 위해서 sudo라는 명령어를 사용합니다. 

이러한 sudo 명령에 대한 사용 권한은 해당 사용자 계정이 sudo 그룹에 소속되어 있느냐에 의해 결정 됩니다.

sudo 그룹에 소속된 사용자만이 sudo 명령을 사용할 수 있습니다.

사용자에게 sudo 권한을 부여하거나 해제하고 싶을 시, sudo 그룹에 사용자를 추가/삭제하면 됩니다.

보안 관리를 위해 **docker**에 사용자를 추가하겠습니다. 

인스턴스 터미널에 `cat /etc/group` 명령어를 입력해봅니다. 

-`cat` : 리눅스에서 파일 내용을 출력해주는 명령어 입니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2018.png)

docker에 아무것도 없습니다.

이제 `sudo usermod -aG docker 본인아이디` 를 해줍니다.

이는 docker에 add group 해달라는 뜻입니다.

그리고 다시  `cat /etc/group` 명령어를 입력해봅니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2019.png)

잘 추가 됐습니다. 

쉘을 껐다가 다시 접속합니다.

---

# Docker 서버 띄우기

본인의 깃허브 저장소 주소를 복사합니다. 

`git clone 저장소_주소` 를 터미널에 입력하고

깃허브 username 을 입력합니다.

비밀번호는 깃허브에서 로그인할 때 토큰을 만들었던 것을 넣어줍니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2020.png)

<aside>
💡 토큰이 없다면, 노션을 참고해 만들어주세요.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2021.png)

</aside>

터미널에서 해당 폴더(`35-01-deploy-with-docker`)로 이동합니다. 

`ls -al` 을 해보면 만들었던 `docker-compose` 파일들은 나오지만, **.gitignore**에 넣었던 **.env** 파일들은 나오지 않습니다. 

`vim`을 이용해 다시 만들어주겠습니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2022.png)

`vi .env.dev` 를 입력하면 파일이 만들어지면서 빈 화면이 나옵니다. 

이때 `i` 를 눌러 수정 모드로 들어갑니다. vscode에서 `.env.dev` 파일의 내용을 복사해 터미널에 붙여넣기 합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2023.png)

다 되었다면 `esc`를 누르고 `:wq` 를 차례로 누르고 엔터를 눌러 저장하고 나갑니다. 

나머지 파일들(`.env.prod`, `.env.stage`)도 필요하다면 같은 방식으로 만들어줍니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2024.png)

이제 아래 명령어를 입력해 도커를 빌드해주고 띄워줍니다.

`docker compose -f docker-compose.dev.yaml build`

`docker compose -f docker-compose.dev.yaml up`

<aside>
💡 도커 컨테이너를 백그라운드에서 계속 돌아가게 하려면 뒤에 `-d` 옵셥을 붙여주세요.
`docker compose -f docker-compose.dev.yaml up -d`

</aside>

---

# 방화벽

서버는 띄웠지만, 아직 접속할 수는 없습니다. 방화벽이 있기 때문입니다.

방화벽을 여는 작업을 해주겠습니다.

GCP 콘솔에서 VPC 네트워크 > 방화벽에 들어갑니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2025.png)

방화벽 규칙 만들기를 클릭합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2026.png)

이름을 지어줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2027.png)

이름과 똑같이 대상 태그를 만들어주겠습니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2028.png)

태그는 스티커와 비슷합니다. 

만들어둔 VM 인스턴스에 이 스티커(태그)를 붙여주면 방화벽 규칙이 적용됩니다.

소스 IP 범위를 입력합니다. 아래와 같이 하면, 누구든지 접속 가능하다는 뜻입니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2029.png)

포트를 지정해줍니다. 3000번 포트에 누구든지 접속할 수 있습니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2030.png)

만들기를 해줍니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2031.png)

> TCP와 UDP는 데이터를 한 컴퓨터에서 다른 컴퓨터로 전달해주는 프로토콜 입니다. 모두 포트번호를 이용하여 주소를 지정해 줍니다.
> 
- TCP는 연결이 성공해야지만 통신이 가능하고, 신뢰성 있는 데이터를 전송합니다.(정확성 추구) 확인 절차를 거쳐야 하므로 성능이 느릴 수 있습니다.
- UDP는 연결 없이 통신이 가능하고, 신뢰성을 보장해 주지 않아 안정성이 떨어질 수가 있습니다. 속도가 빠른 것이 특징입니다.

다시 Compute Engine에  VM 인스턴스를 들어갑니다. 

아까 만든 인스턴스를 수정하겠습니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2032.png)

인스턴스 이름을 클릭해 들어갑니다.

수정을 눌러줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2033.png)

아래로 내려, 네트워크 태그 부분에 아까 만든 태그를 붙여줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2034.png)

`저장`합니다.

### 접속 테스트

이제 IP주소로 접속할 수 있습니다. IP주소:3000 을 입력합니다. 

예 ) `http://34.64.197.158:3000/graphql`

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2035.png)

아래와 같이 플레이그라운드가 잘 나옵니다! ✨

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2036.png)

---

# MYSQL 클라우드 SQL 배포

이번에는 백엔드를 GCP에 따로 배포하겠습니다.

왼쪽 메뉴를 열어 SQL을 눌러줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2037.png)

인스턴스를 만들어줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2038.png)

우리는 MySQL을 사용하기 때문에, MySQL을 선택합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2039.png)

`인스턴스ID`와 root `비밀번호`를 설정하고

MySQL 버전은 `8.0`으로 합니다.

`서울` 리전을 선택하고 인스턴스를 만들어줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2040.png)

5분~10분 정도 기다려주면 SQL 인스턴스가 생성됩니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2041.png)

인스턴스가 생성되면 Nest 서버와 연결시켜야합니다.

왼쪽 메뉴에서 연결을 눌러주세요.

# VPC 피어링

`vpc`(Virtual Private Cloud)란? 일종의 가상 네트워크 센터입니다. 

IP 주소 범위 선택, 서브넷 생성, 라우팅 테이블 및 네트워크 게이트웨이 구성 등 가상 네트워킹 환경을 말합니다.

연결 메뉴에 들어가면 처음에 `공개 IP`에만 체크가 되어있습니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2042.png)

공개 IP(누구든지 다 접속할 수 있기에)의 체크를 풀고, `비공개 IP`에 체크를 합니다. 네트워크를 눌러 `default`를 선택합니다.

밑에 나오는 `연결 설정`을 눌러줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2043.png)

오른쪽에 생긴 설정창에서 `API 사용 설정`을 클릭합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2044.png)

`IP 범위 할당`은 **자동으로 할당된 IP 범위 사용**을 선택하고 **계속**을 누릅니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2045.png)

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2046.png)

`연결 만들기`를 누릅니다.

잠시 기다리면, `default`로 네트워크 연결이 잘 되었습니다.

`저장`을 누릅니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2047.png)

왼쪽 메뉴의 `데이터베이스`로 가서 `데이터베이스 만들기`를 클릭합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2048.png)

이름을 `myproject`로 합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2049.png)

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2050.png)

잘 만들어졌습니다. 

---

### 접속 테스트

왼쪽 메뉴의 개요에서 비공개 IP 주소를 복사합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2051.png)

vscode에서 app.module.ts 파일을 수정합니다.

TypeOrmModule 설정의 host 부분을 방금 복사한 SQL의 `비공개 IP 주소`로 바꿔줍니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2052.png)

깃 커밋 후 푸시합니다.

다시 VM 인스턴스의 쉘로 가서 컨테이너를 종료합니다. 

깃이 있는 프로젝트의 루트로 가서 `git pull` 해줍니다. 

다시 터미널에서 폴더를 이동해 (35-01-deploy-with-docker) 빌드 후, up합니다. 

`docker compose -f docker-compose.dev.yaml build`

`docker compose -f docker-compose.dev.yaml up`

플레이그라운드도 잘 연결되는지 확인해보세요!

---

# DNS 연결

NHN 클라우드에서 사용하기 위해 모두 도메인을 구매했었습니다.

이제 이 도메인을 백엔드 서버와 연결시키겠습니다.

그러면 아이피 주소가 아닌 도메인 주소로 API를 요청할 수 있습니다.

GCP > 네트워크 서비스 > `Cloud DNS` 에 들어가 API `사용`을 누릅니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2053.png)

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2054.png)

`영역 만들기` 클릭

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2055.png)

DNS 이름은 **`구매한 도메인`** 이름과 일치해야합니다. 

영역 이름을 정하고 만들기를 누릅니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2056.png)

도메인 구입한 곳으로 이동해서 네임서버를 변경해줘야합니다.

NS에서 뒤에 점은 제외하고 복사해서 넣어줍니다.

<aside>
⚠️ com 뒤에 온점(`.`)은 지우고 붙여넣기 하셔야합니다!!

</aside>

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2057.png)

가비아의 도메인 관리 페이지에서 네임서버 설정을 열어줍니다.

[](https://domain.gabia.com/manage/changeinfo)

원하는 도메인을 체크하고 `네임 서버`를 클릭합니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2058.png)

복사한 내용을 하나씩 적어줍니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2059.png)

`소유자 인증` 후 `적용`을 누릅니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2060.png)

<aside>
💡 이제 이 도메인은 구글에서 관리합니다!
미니 프로젝트에서 진행했던 문자/이메일 발송을 사용하기 위해 필요했던 TXT 설정을
GCP의 Cloud DNS에서 `레코드 세트 추가`를 눌러 똑같이 추가해주세요.

</aside>

확인해보겠습니다. 

다시 GCP 콘솔로 돌아와 오른쪽 위의 클라우드의 쉘에 들어갑니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2061.png)

`dig 도메인_이름 NS` 도메인 이름을 넣어서 명령어를 입력합니다.

반영되는데 시간이 걸릴 수 있습니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2062.png)

Cloud DNS 화면에서 레코드 세트 추가를 누릅니다.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2063.png)

VM 인스턴스의 IP 주소를 복사합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2064.png)

레코드 모음 만들기에서 IP 주소에 복사한 인스턴스의 IP 주소를 넣어줍니다. 

A 레코드 유형을 선택하고 만들기를 누릅니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2065.png)

다시 오른쪽 위에 클라우드 쉘에 접속해 명령어를 입력합니다. 

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2061.png)

`dig 도메인주소 A`

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2066.png)

A 레코드가 반영 됐는지 확인합니다.

이제 도메인주소로 접속할 수 있습니다. 

`http://본인의_도메인_주소:3000/graphql` 로 접속해보세요.

![Untitled](BE%20Day33%20GCP%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3%E1%84%90%E1%85%A5%E1%86%AB%E1%84%89%E1%85%B3%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%204737e5ad5ce14b929066582da33e8829/Untitled%2067.png)